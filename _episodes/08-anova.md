---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 08-anova.md in _episodes_rmd/
title: "Linear regression and analysis of variance"
teaching: 0
exercises: 0
questions:
- "How do I evaluate the quality of a linear model?"
- "What are the components that make up a one fixed factor linear regression model?"
- "What are the assumptions of linear regression, and how can you test for them?"
- "What are residuals and why are they important?"
- "When should outliers be removed from a study?"
objectives:
- "Understand the assumptions behind linear models and ANOVA."
- "Perform linear regression and interpret results."
- "Evaluate model quality by examining the residuals."
- "Know when and how to transform your data."
keypoints:
- "When performing a linear regression or ANOVA, ensure that data meet the assumptions for this chosen method."
- "Examining the residuals (or errors) is a key part of linear regression."
- "Transform your data if it appears to have many outliers or would benefit from a transformation such as logarithmic."
source: Rmd
---



## Linear Regression
Linear regression describes how one variable changes dependent on another one, or two, or more variables. For example, we can use linear regression to model human height as a function of gender.





The linear model describes the line of best fit to the data, and can be expressed as an equation <i>y</i> = <i>&beta;<sub>0</sub></i> + <i>&beta;<sub>1</sub></i>x + <i>&epsilon;</i>

where 

&nbsp;&nbsp;&nbsp;<i>y</i> is the dependent variable, height
&nbsp;&nbsp;&nbsp;<i>&beta;<sub>0</sub></i> is the y-axis intercept
&nbsp;&nbsp;&nbsp;<i>&beta;<sub>1</sub></i> is the slope of the line
&nbsp;&nbsp;&nbsp;<i>x</i> is the independent variable, gender, and
&nbsp;&nbsp;&nbsp;<i>&epsilon;</i> is the error (also called residual)

This is similar to the equation <i>y</i> = <i>m</i><i>x</i> + <i>b</i> that you might be familiar with from many years ago.

We can use linear regression to predict the mean value of a dependent, or response variable according to the value of one or more independent variables, or predictors. In the following example we'll explore how body weight (the dependent variable) changes depending on diet composition (the independent variable). 

## Data

This data set contains body weights for 846 male (M) and female (F) mice fed a high fat (hf) and control (chow) diet measured repeatedly over 23  time points (BW.3 – BW.30).  Many mice do not have measurements for all body weight as survival time varies across sample.  Data set includes additional information, such as litter number and coat color. Load the data and have a quick look.


~~~
library(car)
~~~
{: .language-r}



~~~
Loading required package: carData
~~~
{: .output}



~~~

Attaching package: 'car'
~~~
{: .output}



~~~
The following object is masked from 'package:dplyr':

    recode
~~~
{: .output}



~~~
pheno <- read.csv(file = "../data/bodyWeights.csv", stringsAsFactors = FALSE)
names(pheno)
~~~
{: .language-r}



~~~
 [1] "Sample"     "Sex"        "Gen"        "Litter"     "Diet"      
 [6] "Coat.Color" "BW.3"       "BW.4"       "BW.5"       "BW.6"      
[11] "BW.7"       "BW.8"       "BW.9"       "BW.10"      "BW.11"     
[16] "BW.12"      "BW.13"      "BW.14"      "BW.15"      "BW.16"     
[21] "BW.17"      "BW.18"      "BW.19"      "BW.20"      "BW.21"     
[26] "BW.22"      "BW.23"      "BW.24"      "BW.25"      "BW.26"     
[31] "BW.27"      "BW.28"      "BW.29"      "BW.30"     
~~~
{: .output}



~~~
head(pheno)
~~~
{: .language-r}



~~~
  Sample Sex Gen Litter Diet Coat.Color BW.3 BW.4  BW.5  BW.6  BW.7  BW.8
1    F01   F   4      2   hf     agouti   NA   NA 17.58 22.31 25.12 26.32
2    F02   F   4      2   hf      black   NA   NA 19.70 24.74 26.08 28.36
3    F03   F   4      2   hf      white   NA   NA 18.53 20.82 20.07 20.61
4    F04   F   4      2   hf     agouti   NA   NA 14.02 17.39 18.47 19.07
5    F05   F   4      2   hf     agouti   NA   NA 18.54 23.54 22.77 25.22
6    F06   F   4      2   hf     agouti   NA   NA 17.59 20.06 20.09 21.00
   BW.9 BW.10 BW.11 BW.12 BW.13 BW.14 BW.15 BW.16 BW.17 BW.18 BW.19 BW.20
1 29.38 29.45 30.22 31.94 30.61 33.87 35.17 36.45 34.63 36.42 36.78 35.46
2 30.09 30.76 30.47 32.48 32.37 33.53 33.58 35.69 35.62 37.23 37.65 35.76
3 20.96 22.01 21.48 22.82 22.33 22.78 21.41 23.60 23.12 23.67 24.37 24.12
4 18.97 18.85 19.72 19.92 19.29 19.38 17.96 20.27 19.80 21.24 21.51 21.09
5 27.54 27.52 29.24 32.22 33.76 33.31 33.07 35.25 35.06 37.46 39.35 39.38
6 23.31 24.65 25.14 27.50 28.55 31.02 30.59 33.78 34.03 37.45 37.57 35.30
  BW.21 BW.22 BW.23 BW.24 BW.25 BW.26 BW.27 BW.28 BW.29 BW.30
1 36.31    NA    NA    NA    NA    NA    NA    NA    NA    NA
2 35.63    NA    NA    NA    NA    NA    NA    NA    NA    NA
3 24.00    NA    NA    NA    NA    NA    NA    NA    NA    NA
4 20.55    NA    NA    NA    NA    NA    NA    NA    NA    NA
5 39.02    NA    NA    NA    NA    NA    NA    NA    NA    NA
6 35.76    NA    NA    NA    NA    NA    NA    NA    NA    NA
~~~
{: .output}

The data are from a repeated measures design, in which the same subject is measured over time. Although this data represents a repeated measures experiment, it can also be analyzed as ANOVA (Analysis of Variance) by evaluating only a single time point’s body weight measurement.  Due to the additional complexity of a repeated measures experiment over a standard ANOVA, the following statistical analysis example will focus only on the analysis of body weights at 10 weeks (BW.10).

## Statistical Analysis Assumptions (of Linear Regression / ANOVA)

In the following example, we model body weight at 10 weeks as a function of diet.

![](../fig/linear-model.png)

The residuals (or errors one if which is shown by the vertical, red-dashed line in the plot above) are the distance of each data point (a light blue circle) from the (blue) line describing the linear model. 

To ensure that a statistical analysis can accurately evaluate a data set, there are certain criteria (or assumptions) that need to be met.

For our analysis of body weight at 10 weeks and diet, the following assumptions should be met:

1. The model is good (i.e. the relationship is linear and not, for example, quadratic or exponential).  
1. The residuals have a normal distribution (*the data don't necessarily need to be normally distributed, but the residuals do*).  
1. The residuals have equal variance (homoscedastic).  

If we look at a histogram of the residuals, they should be normally distributed.  A normal, or Gaussian, distribution is identified by having a mean, median, and mode that are all equal, and the data generate a curve that is symmetric at the center (or mean).

![](../fig/residual-histogram.png)

You can also plot the residuals against the fitted values in the model to check assumption number 3, that the residuals have equal variance.


~~~
plot(model, which = 1)
~~~
{: .language-r}



~~~
Error in plot(model, which = 1): object 'model' not found
~~~
{: .error}

Note that the residuals are plotted along one of two fitted values - the one for standard chow (25.9), or the predicted value for high-fat diet (28.5). There should be constant variance vertically and points should scatter symmetrically around zero. The plot indicates the 3 data points that stand out as outliers, with index numbers supplied for each.   

Let's create the model and explore the residuals and fitted values.


~~~
# Model body weight at 10 weeks as a function of diet
model <- lm(formula = BW.10 ~ Diet, data = pheno)
summary(model)
~~~
{: .language-r}



~~~

Call:
lm(formula = BW.10 ~ Diet, data = pheno)

Residuals:
     Min       1Q   Median       3Q      Max 
-13.0701  -4.2509  -0.4101   3.7741  20.4399 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept)  25.8909     0.2649  97.739  < 2e-16 ***
Diethf        2.6392     0.3875   6.811 1.84e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.613 on 841 degrees of freedom
  (3 observations deleted due to missingness)
Multiple R-squared:  0.05228,	Adjusted R-squared:  0.05116 
F-statistic:  46.4 on 1 and 841 DF,  p-value: 1.84e-11
~~~
{: .output}



~~~
# Look at the first few values of the residuals
head(model$residuals)
~~~
{: .language-r}



~~~
         1          2          3          4          5          6 
 0.9198985  2.2298985 -6.5201015 -9.6801015 -1.0101015 -3.8801015 
~~~
{: .output}



~~~
# Look at the first few values fitted by the model
head(model$fitted.values)
~~~
{: .language-r}



~~~
      1       2       3       4       5       6 
28.5301 28.5301 28.5301 28.5301 28.5301 28.5301 
~~~
{: .output}

Note that the first several fitted values are the same. These are the predicted mean body weights for a high-fat  diet. What are the predicted values for a standard chow diet?


~~~
table(round(model$fitted.values, digits = 4))
~~~
{: .language-r}



~~~

25.8909 28.5301 
    449     394 
~~~
{: .output}

The difference between predicted values for standard chow vs. high-fat diet is approximately 2.6, which is the slope of the line describing the linear model. 

## The residuals: a key part of statistical modeling

Residuals are estimates of experimental error obtained by subtracting the observed responses from the predicted responses (or actual data from data set minus what is predicted by the model).  The predicted response (or fitted value) is the dependent variable (y-value) that is predicted by the model based on all the accounted for independent variables (x-values). 

A fitted value is simply another name for a predicted value as it describes where a particular x-value fits the line of best fit. It is found by substituting a given value of x into the regression equation. A residual denoted (e) is the difference or error between an observed observation and a predicted or fit value

Examining residuals is a key part of all statistical modeling.  Carefully looking at residuals can tell us whether our assumptions are reasonable and our choice of model is appropriate.

Residuals are elements of variation unexplained by the model.  Residuals should be (roughly) normal and (approximately) independently distributed with a mean of zero and some constant variance.  If error is not normal or independently distributed this would indicate that a different (nonlinear) model may be more suitable to analyze the data or that other significant factors need to be accounted for.  For example, if predicting BW.10 we only used a model with Sex, we may obtain poor residual plots because we are failing to account for a crucial factor, such as, Diet.  Show example of residual plots only using Sex (and provide the R code).

Now create a histogram of the residuals to check for a normal distribution.


~~~
hist(model$residuals, breaks = 20)
~~~
{: .language-r}


We can also use a quantile vs. quantile (Q-Q) plot to compare the residuals to a normal distribution. 


~~~
plot(model, which = 2)
~~~
{: .language-r}

<img src="../fig/rmd-08-qq_plot-1.png" title="plot of chunk qq_plot" alt="plot of chunk qq_plot" style="display: block; margin: auto;" />

The Q-Q plot indicates 3 data points that are outliers along with their index numbers. Otherwise, most of the points lie along the diagonal line, indicating that the residuals are normally distributed. 




## A Bad Model
Now let's look at one that is unmistakably bad. This is a linear model created from a fake dataset. Notice that the slope of the line is nearly horizontal.



![](../fig/bad-linear-model.png)

If we look at a summary of the linear model, we can see that the residuals aren't normally distributed.


~~~

Call:
lm(formula = y ~ x, data = bad_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.9655 -0.6571 -0.2960  0.3739  4.3349 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept)  0.79187    0.11707   6.764 3.19e-11 ***
x            0.08748    0.07404   1.182    0.238    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.9068 on 598 degrees of freedom
Multiple R-squared:  0.002329,	Adjusted R-squared:  0.0006609 
F-statistic: 1.396 on 1 and 598 DF,  p-value: 0.2378
~~~
{: .output}

Notice that the slope (Estimate column) is near zero (0.087482), indicating no relationship between the two variables.

The histogram for the residuals doesn't show a normal distribution, which is one of the three important assumptions for linear models. 

<img src="../fig/rmd-08-bad_model_hist-1.png" title="plot of chunk bad_model_hist" alt="plot of chunk bad_model_hist" style="display: block; margin: auto;" />

In the Q-Q plot most of the data points are off-diagonal. If we compare the Q-Q plot for the bad model with our earlier model, we can see that most of the residuals fall well outside of the confidence interval.


~~~
Error in is.data.frame(data): object 'pheno' not found
~~~
{: .error}



~~~
Error in is.data.frame(data): object 'bad_data' not found
~~~
{: .error}

To produce Q-Q plots with confidence intervals (shown in dashed blue lines), use the `qqPlot()` function in the `car` library. The default argument for the confidence interval is `envelope=.95` for a 95% confidence interval. You can change this argument to a greater or lesser value, or you can set it to `FALSE` for no confidence interval around the diagonal.

<img src="../fig/rmd-08-bad_model_v_good-1.png" title="plot of chunk bad_model_v_good" alt="plot of chunk bad_model_v_good" style="display: block; margin: auto;" />

The good model is shown at left and the bad model at right above. Notice that the residuals for the good model are centered very close to zero and have an equal spread above and below zero. For the bad model at right, the residuals aren't centered at zero and don't appear to be equally spread above and below.

## Outliers

If outliers are present in the data, data transformation might be a consideration.  Alternatively, if outlier values are believed to be the result of real error (e.g. calculation error, data entry, etc.) then they may be removed from the dataset.  Excluding values must only be done for legitimate reasons, or else you may affect the Type 1 (false positive) error rate.

Include plot of distribution of data (include R box plot code).  Highlight any outliers.  Go over how to read a box plot.  Show example of outliers if none are present in data.

## A Model of Body Weight, Sex, and Diet

Let's return to the body weight data to evaluate a model of body weight as a function of both diet and sex. Evaluating the assumptions of the statistical test requires that a model be created.  A statistical model is a mathematical representation of the factors that can be used to predict a certain value.  For example, in our effort to predict body weight at 10 weeks, we will use the sex and diet of mice which are represented in the form of a statistical model.

The first step in analyzing data is to create an appropriate model.  Given our data set, we would like to determine if the dependent variable of body weight (BW.10) is influenced by the independent variables sex and diet.  The model for this analysis is:

![](../fig/bw-sex-diet-eqn.png)

where the subscript <i>i</i> refers to the individual sample. The mathematical function consists of two main parts. These parts are known as the predictor variables (or regressors), e.g., <i>sex<sub>i</sub></i>,… , and the parameters (or regression coefficients), e.g., <i>&beta;<sub>1</sub></i>,…. Like the parameters (or regression coefficients) in the mathematical function, the random errors are unknown. The error (or residual) is simply the difference between what is seen in the data set versus what is predicted by the mathematical function.

&nbsp;&nbsp;&nbsp;<i>BW.10<sub>i</sub></i> = the dependent (or response variable), body weight at 10 weeks, associated with sample <i>i</i>.

&nbsp;&nbsp;&nbsp;<i>&beta;<sub>0</sub></i> = mean intercept (or constant); for scientific studies the intercept is often not of interest and is only used to aid in calculation of predicted values. In our first linear model of body weight and diet, <i>&beta;<sub>0</sub></i> (the y-intercept) equaled 25.9. It's not meaningful, however, because it predicts that a mouse on neither diet has a body weight of 25.9.

&nbsp;&nbsp;&nbsp;<i>&beta;<sub>1</sub></i> = parameter associated with the regressor Sex. This number is a constant like the value of 2.6 in the first linear model that we explored.

&nbsp;&nbsp;&nbsp;<i>&beta;<sub>2</sub></i> = parameter associated with the regressor Diet; also a constant.

&nbsp;&nbsp;&nbsp;<i>sex<sub>i</sub></i> = a regressor that varies according to the ith sample’s sex (male or female)

&nbsp;&nbsp;&nbsp;<i>diet<sub>i</sub></i> = a regressor that varies according to the ith sample’s diet (standard chow or high-fat)

&nbsp;&nbsp;&nbsp;<i>&epsilon;<sub>i</sub></i> = error (or residual) associated with observation i

The response variable, <i>BW.10</i>, is a quantity that varies in a way that we hope to be able to summarize and exploit via the modeling process. Generally, it is known that the variation of the response variable is systematically related to the values of one or more other variables (such as, Sex and Diet) before the modeling process is begun, although testing the existence and nature of this dependence is part of the modeling process itself.


~~~
# Model body weight at 10 weeks as a function of sex and diet
model2 <- lm(formula = BW.10 ~ Sex + Diet, data = pheno)
summary(model2)
~~~
{: .language-r}



~~~

Call:
lm(formula = BW.10 ~ Sex + Diet, data = pheno)

Residuals:
     Min       1Q   Median       3Q      Max 
-11.1563  -2.8839  -0.2099   2.4579  18.3458 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept)  22.2779     0.2503  88.992   <2e-16 ***
SexM          7.2420     0.2954  24.517   <2e-16 ***
Diethf        2.6863     0.2960   9.075   <2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.288 on 840 degrees of freedom
  (3 observations deleted due to missingness)
Multiple R-squared:  0.4476,	Adjusted R-squared:  0.4463 
F-statistic: 340.3 on 2 and 840 DF,  p-value: < 2.2e-16
~~~
{: .output}



~~~
# Look at the first few values of the residuals
head(model2$residuals)
~~~
{: .language-r}



~~~
         1          2          3          4          5          6 
 4.4857802  5.7957802 -2.9542198 -6.1142198  2.5557802 -0.3142198 
~~~
{: .output}



~~~
# Look at the first few values fitted by the model
head(model2$fitted.values)
~~~
{: .language-r}



~~~
       1        2        3        4        5        6 
24.96422 24.96422 24.96422 24.96422 24.96422 24.96422 
~~~
{: .output}


~~~
hist(model2$residuals, breaks = 20)
~~~
{: .language-r}

<img src="../fig/rmd-08-histogram2-1.png" title="plot of chunk histogram2" alt="plot of chunk histogram2" style="display: block; margin: auto;" />

Check for normal distribution of the residuals with a Q-Q plot. 


~~~
plot(model2, which = 2)
~~~
{: .language-r}

<img src="../fig/rmd-08-qq_plot2-1.png" title="plot of chunk qq_plot2" alt="plot of chunk qq_plot2" style="display: block; margin: auto;" />



Plot the residuals against the fitted values in this second model.


~~~
plot(model2, which = 1)
~~~
{: .language-r}

<img src="../fig/rmd-08-resid_vs_fitted2-1.png" title="plot of chunk resid_vs_fitted2" alt="plot of chunk resid_vs_fitted2" style="display: block; margin: auto;" />

Note that there are now 4 different groups - one for each combination of sex and diet.


Include R example of using aov() to setup an analysis of variance to predict BW.10 using both Sex and Diet factors.  May wish to mention the use of “lme” when you need to account for both fixed and random factors, such as when a random term is required for accounting for technical replicates (or other factors).
